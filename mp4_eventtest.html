<html>
<head>
    <script type="text/javascript">
            var timerStart = Date.now();
    </script>

</head>

<body>
  <video id="my-video" 
  		 width = "1080" 
  		 autoplay 
  		 controls 
  		 muted >
  		 <source src="https://res.cloudinary.com/dougsillars/video/upload/v1562844864/rbsp_launch_720p_gz9zfm.mp4">
  		 
  		 <!--
  		 big video and Im on crappy wifi
  		 <source src="https://res.cloudinary.com/dougsillars/video/upload/v1562844864/rbsp_launch_720p_gz9zfm.mp4">
  		 -->
   </video>
  <p>

   <div class="buffered">
  		<span id="buffered-amount"></span>
	</div>
	<div class="progress">
  		<span id="progress-amount"></span>
	</div>
	
	
	<h2>
     <div id="networkspeed"> 
	 </div>
	 <div id="playbackstate"> 
	 </div>
	 <div id="timetostart"> 
	 </div>
     <div id="videotime"> 
	 </div>
	<div id="bufferstate"></div>
	
<svg  id="svg" width = "1000" height = "100" class="chart">  
  <polyline id="polyline-red"
     fill="none"
     stroke="red"
     stroke-width="10"
     points=""/>
   <polyline id="polyline-orange"
     fill="none"
     stroke="orange"
     stroke-width="10"
     points=""/>
      <polyline id="polyline-green"
     fill="none"
     stroke="green"
     stroke-width="10"
     points=""/>
</svg>
	 <div class="bufferstats" width = "1000" display ="flex">  
	   <div class="danger" width = "300">
	   	Danger (<5s):
	   	<div id="dangervalue"></div>
	   </div>
	   
	   <div class="low" width = "300">
	      Low (5-10s):
	      <div id="lowvalue"></div>
	    </div>
	   <div class="safe" width = "300">
	    Safe (>10s):
	    <div id="safevalue"></div>
	   </div>
	 </div>
	 </div> 
	<div id="stallstate">
	stall data
	 </div>
	 	<div id="stallsum">
	 	total stall data
	 </div>
	
</h2>
	 
	 
     <div id="events">
	 </div>
	 

	
  <style>
  .events{
    height: 200px;
    position: relative;
    width: 1000px;
  }
  
  .buffered {
  height: 20px;
  position: relative;
  background: #555;
  width: 1000px;
}

#buffered-amount {
  display: block;
  height: 100%;
  background-color: #777;
  width: 0;
}

.progress {
  margin-top: -20px;
  height: 20px;  
  position: relative;
  width: 1000px;
}

#progress-amount {
  display: block;
  height: 100%;
  background-color: #595;
  width: 0;
}
div.danger {
  color: #FF0000;
 }
 .low {
  color: orange;
 }
  .safe {
  color: green;
 }
  
  </style>
  <script>	
  
  //get a video url from the query string. Fall back to NASA rocket if no video
    var videoUrl = "https://res.cloudinary.com/dougsillars/video/upload/v1562844864/rbsp_launch_720p_gz9zfm.mp4";
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('video')){
    	videoUrl = urlParams.get('video')
    	}
    //set video source	
    document.getElementById("my-video").src	 = videoUrl;
   
   
    
    var scriptEvalStart = Date.now();
    window.onload = function(){

    var videoStatus = "Not Started";
    //set initial state
    document.getElementById("playbackstate").innerHTML = videoStatus;
    
  	var myVideo = document.getElementById('my-video');
    var bufferMax= 0;
    var videoStopTime =0;
    var videoStartTime =0;
    var stallTimeSum =0;
    var stallCounter = 0;
    var buffertimer = 0;
    var bufferDanger=0;
    var bufferLow=0;
    var bufferSafe=0;
    //metadataloaded at startup
    
    
    myVideo.addEventListener('loadedmetadata', function() {
     var metadataLoadTime =  Date.now();
     var onloadtoMetadata = metadataLoadTime - timerStart;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus +" Metadata Loaded elapsed: " + onloadtoMetadata);
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    
    
    //ID when the video has begun downloading
    myVideo.addEventListener('loadeddata', function() {
     var loadedTime =  Date.now();
     var onloadtoLoaded = loadedTime - timerStart;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus +" Video Data Loading elapsed: " + onloadtoLoaded);         
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    
    //ID when the playback starts
    myVideo.addEventListener('play', function() {
    console.log("play");
     videoStatus = "playing"
     document.getElementById("playbackstate").innerHTML = videoStatus;
     var playTime =  Date.now();
     if(videoStopTime >0){
     	//this could be a stall
     	var stallTime = (playTime - videoStopTime);
     	//total stall time
     	stallTimeSum+= stallTime;
     	stallCounter+=1;
     	var stall = "stalled for: " +stallTime;
     	var stallTotal = "Stall count: " + stallCounter+ " time: " + stallTimeSum;
     	document.getElementById("stallstate").innerHTML = stall;
     	document.getElementById("stallsum").innerHTML = stallTotal;
     	console.log(stall);
     	console.log(stallTotal);

     	}
     else if (videoStopTime ==0){
        //this is the initial startup

        var videoStart = playTime - scriptEvalStart;
        var startupTime = "Video Start Time: " +videoStart;
     	document.getElementById("timetostart").innerHTML = startupTime;
     	console.log(startupTime);
        }

                                         
    });

    //ID when the video has begun playing
    myVideo.addEventListener('playing', function() {
      console.log("playing");
      videoStatus = "playing"
      document.getElementById("playbackstate").innerHTML = videoStatus;
     var playTime =  Date.now();
     if(videoStopTime >0){
     	//this could be a stall
     	var stallTime = (playTime - videoStopTime);
     	//total stall time
     	stallTimeSum+= stallTime;
     	stallCounter+=1;
     	var stall = "stalled for: " +stallTime;
     	var stallTotal = "Stall count: " + stallCounter+ " time: " + stallTimeSum;
     	document.getElementById("stallstate").innerHTML = stall;
     	document.getElementById("stallsum").innerHTML = stallTotal;
     	console.log(stall);
     	console.log(stallTotal);

     	}
     else if (videoStopTime ==0){
        //this is the initial startup
        var videoStart = playTime - scriptEvalStart;
        var startupTime = "Video Start Time: " +videoStart;
     	document.getElementById("timetostart").innerHTML = startupTime;
     	console.log(startupTime);
      }	                            

    });
    
    /*
    //ID when the video has be played through
    myVideo.addEventListener('canplaythrough', function() {
     var loadedTime =  Date.now();
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video can Play through: " +loadedTime);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    */
//ID when the video is waiting
    myVideo.addEventListener('waiting', function() {
    videoStatus = "waiting"
    document.getElementById("playbackstate").innerHTML = videoStatus;
     var loadedTime =  Date.now();
     videoStopTime = loadedTime;
//     document.getElementById("stoptime").innerHTML = videoStopTime;
     //var x = document.createElement("P");                        
     //var t = document.createTextNode("Video status: " +videoStatus + " waiting for data: " +loadedTime);    
     //x.appendChild(t);                                           
     //document.getElementById("events").appendChild(x);
     //console.log(t);
    });
    
    
    //ID when the video has stalled
    myVideo.addEventListener('stalled', function() {
    videoStatus = "stalled"
    document.getElementById("playbackstate").innerHTML = videoStatus;
     var loadedTime =  Date.now();
     videoStopTime = loadedTime;
 //    document.getElementById("stoptime").innerHTML = videoStopTime;
     //var x = document.createElement("P");                        
     //var t = document.createTextNode("stalled: " +loadedTime);    
     //x.appendChild(t);                                           
     //document.getElementById("events").appendChild(x);
     //console.log(t);
    });
    
    //ID when the video buffer has been emptied
    myVideo.addEventListener('emptied', function() {
    videoStatus = "empty buffer"
    document.getElementById("playbackstate").innerHTML = videoStatus;
     var loadedTime =  Date.now();
     videoStopTime = loadedTime;
     document.getElementById("stoptime").innerHTML = videoStopTime;
     var x = document.createElement("P");                        
     var t = document.createTextNode("emptied: " +loadedTime);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
        
    /*
    //download still in progress
     myVideo.addEventListener('progress', function() {
     var duration =  myVideo.duration;
     console.log("progress" );
     if (duration > 0) {
    for (var i = 0; i < myVideo.buffered.length; i++) {
            if (myVideo.buffered.start(myVideo.buffered.length - 1 - i) < myVideo.currentTime) {
                var timeInBuffer = ((myVideo.buffered.end(myVideo.buffered.length - 1)) - myVideo.currentTime).toFixed(2);
                document.getElementById("buffered-amount").style.width = (myVideo.buffered.end(myVideo.buffered.length - 1 - i) / duration) * 100 + "%";
     			document.getElementById("bufferstate").innerHTML = "Video Buffer (s):" +timeInBuffer;
     			var playback = "video (s): " +myVideo.currentTime.toFixed(2);
     			document.getElementById("videotime").innerHTML = playback;
     			console.log(timeInBuffer );
     			break;
                }
            }
         }


    });*/
    
    
    //this runs every 250 ms
    myVideo.addEventListener('timeupdate', function() {
      //network speed
      var downLink = "Connection Speed: "+ navigator.connection.downlink + " MBPS";
      document.getElementById("networkspeed").innerHTML =  downLink;
      //console.log(downLink);
    
       var duration =  myVideo.duration;
    
    
       //calculate time in buffer
       var timeInBuffer = ((myVideo.buffered.end(myVideo.buffered.length - 1)) - myVideo.currentTime).toFixed(2);
       document.getElementById("buffered-amount").style.width = (myVideo.buffered.end(myVideo.buffered.length - 1 ) / duration) * 100 + "%";
       document.getElementById("bufferstate").innerHTML = "Video Buffer (s):" +timeInBuffer;
       //console.log(timeInBuffer );
       
       
       
       //imma gonna try to add to a svg live
        
        //number of x points
        //width of 1000
        //points are duration *4
        var xlength = 1000/(duration*4);
        //assume max buffer is 30
        var ylength = 100/30;
        
        var svg = document.getElementById('svg');
        var point = svg.createSVGPoint();
         point.x = buffertimer*xlength;
         point.y = 100- timeInBuffer*ylength;
         var polyline= document.getElementById('chart-polyline1');
        // var stroke = svg.createSVGStroke();
         
                
         //increment the timer
         buffertimer +=1;
       //report back important stuff about buffertime
       if (bufferMax < timeInBuffer){
       		bufferMax = timeInBuffer;
            }
       if (timeInBuffer < 10){
       		if (timeInBuffer < 5){
       			//I'll call this the danger zone
       			bufferDanger += 250;
       			polyline= document.getElementById('polyline-red');
       		}else{
       			//under 10 but over 5 - call this low buffer
       			bufferLow +=250;
       			polyline= document.getElementById('polyline-orange');
       		}
       } else {
       	 //over 10 probably ok
       	 bufferSafe +=250;
       	polyline= document.getElementById('polyline-green');
       }
       
       polyline.points.appendItem(point); 
       //console.log(point);
        document.getElementById("dangervalue").innerHTML = bufferDanger;
        document.getElementById("lowvalue").innerHTML = bufferLow;
        document.getElementById("safevalue").innerHTML = bufferSafe;
        


        
        //playbacktime
       var playback = "video (s): " +myVideo.currentTime.toFixed(2);
       document.getElementById("videotime").innerHTML = playback;
       document.getElementById('progress-amount').style.width = ((myVideo.currentTime / duration)*100) + "%";
       
       
      
    });
    
    
        
    //Video has ended playing.. final stats
    myVideo.addEventListener('ended', function() {
    videoStatus = "ended"
    //if the video plays all the way through, there will be 5s in yellow and 5s in red (as buffer plays out)
    //there might also be some at startup
    var duration =  myVideo.duration;
    var expectedDanger = 5/duration*100;
    var expectedLow = 5/duration*100;   
    
    
    document.getElementById("playbackstate").innerHTML = videoStatus;
     var loadedTime =  Date.now();
     var percentDanger = (bufferDanger/1000/duration*100).toFixed(2);
     var percentLow = (bufferLow/1000/duration*100).toFixed(2);
     var percentSafe = (bufferSafe/1000/duration*100).toFixed(2);
     //lets say if 5% of video playback is in danger, or 10% is in low ist should be flagged
     var dangerFlag = percentDanger - expectedDanger;
     var lowFlag = percentLow- expectedLow;
     var stallWarning = "";
     if(dangerFlag >5 || lowFlag >10){
       //we've got potential stall situation
       stallWarning =" your video had very little video in the buffer during playback. consider lowering the bitrate."
     }
     
     var x = document.createElement("P");                        
     var t = document.createTextNode("total stalls: " +stallCounter + 
                                     " stall time: " + stallTimeSum +
                                     " buffer Level Danger: " + percentDanger +
                                     "% Low: " + percentLow +"% Safe: "+ percentSafe +"%"
                                     + stallWarning);    
     
     
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    

   }
   
	
	
  </script>
</body>

</html>