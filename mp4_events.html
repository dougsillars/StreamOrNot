<html>
<head>
    <script type="text/javascript">
            var timerStart = Date.now();
    </script>

</head>

<body>
  <video id="my-video" 
  		 width = "1080" 
  		 autoplay 
  		 controls 
  		 muted >
  		 <source src="https://res.cloudinary.com/dougsillars/video/upload/v1562844864/rbsp_launch_720p_gz9zfm.mp4">
  		 
  		 <!--
  		 big video and Im on crappy wifi
  		 <source src="https://res.cloudinary.com/dougsillars/video/upload/v1562844864/rbsp_launch_720p_gz9zfm.mp4">
  		 -->
   </video>
  <p>

   <div class="buffered">
  		<span id="buffered-amount"></span>
	</div>
	<div class="progress">
  		<span id="progress-amount"></span>
	</div>
	
     <div id="events">
	 </div>
  <style>
  .events{
    height: 200px;
    position: relative;
    width: 300px;
  }
  
  .buffered {
  height: 20px;
  position: relative;
  background: #555;
  width: 300px;
}

#buffered-amount {
  display: block;
  height: 100%;
  background-color: #777;
  width: 0;
}

.progress {
  margin-top: -20px;
  height: 20px;  
  position: relative;
  width: 300px;
}

#progress-amount {
  display: block;
  height: 100%;
  background-color: #595;
  width: 0;
}
  
  
  </style>
  <script>	
    console.log(window.performance);
    
    window.onload = function(){

    var videoStatus = "Not Started";
  	var myVideo = document.getElementById('my-video');
    var bufferMax= 0;
    var videoStopTime =0;
    var videoStartTime =0;
    var stallTimeSum =0;
    var stallCounter = 0;
    //metadataloaded at startup
    
    
    myVideo.addEventListener('loadedmetadata', function() {
     var metadataLoadTime =  Date.now();
     var onloadtoMetadata = metadataLoadTime - timerStart;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus +" Metadata Loaded elapsed: " + onloadtoMetadata);
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    
    
    //ID when the video has begun downloading
    myVideo.addEventListener('loadeddata', function() {
     var loadedTime =  Date.now();
     var onloadtoLoaded = loadedTime - timerStart;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus +" Video Data Loading elapsed: " + onloadtoLoaded);         
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    
    //ID when the playback starts
    myVideo.addEventListener('play', function() {
     videoStatus = "playing"
     var playTime =  Date.now();
     var onloadToPlayBack = playTime - timerStart;
//     var x = document.createElement("P");                        
//     var t = document.createTextNode("Video starts: " +onloadToPlayBack);  
//     x.appendChild(t);
//     console.log(t);
     
     if(videoStopTime >0){
     	//this could be a stall
     	var stallTime = (playTime - videoStopTime);
     	stallCounter+=1;
     	var tStall = document.createTextNode("Video status: " +videoStatus + " stalled for: " +stallTime);
     	x.appendChild(tStall); 
     	document.getElementById("events").appendChild(x);
     	console.log(tStall);
     	stallTimeSum+= stallTime;
     	}
     else if (videoStopTime =0){
        //this is the initial startup
        var onloadtovideoStart = playTime - onLoad;
        var tStartupTime = document.createTextNode("Video status: " +videoStatus + " Video Start Time: " +onloadToPlayBack);
     	var x = document.createElement("P");
     	x.appendChild(tStartupTime);
     	document.getElementById("events").appendChild(x);
     	console.log(tStartupTime);
        }
    //this will add t, and tstall or tStartupTime
                                         
    });

    //ID when the video has begun playing
    myVideo.addEventListener('playing', function() {
      videoStatus = "playing"
     var playTime =  Date.now();
     var onloadToPlayBack = playTime - timerStart;
//     var x = document.createElement("P");                        
//     var t = document.createTextNode("Video starts: " +onloadToPlayBack);  
//     x.appendChild(t);
//     console.log(t);
     
     if(videoStopTime >0){
     	//this could be a stall
     	var stallTime = (playTime - videoStopTime);
     	stallCounter+=1;
     	var tStall = document.createTextNode("Video status: " +videoStatus +" stalled for: " +stallTime);
     	var x = document.createElement("P");
     	x.appendChild(tStall); 
     	console.log(tStall);
     	document.getElementById("events").appendChild(x);
     	stallTimeSum+= stallTime;
     	}
     else if (videoStopTime =0){
        //this is the initial startup
        var onloadtovideoStart = playTime - onLoad;
        var tStartupTime = document.createTextNode("Video status: " +videoStatus +" Video Start Time: " +onloadToPlayBack);
     	var x = document.createElement("P");
     	x.appendChild(tStartupTime);
     	document.getElementById("events").appendChild(x);
     	console.log(tStartupTime);
        }
    //this will add t, and tstall or tStartupTime
                                  

    });
    //ID when the video has be played through
    myVideo.addEventListener('canplaythrough', function() {
     var loadedTime =  Date.now();
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus + " Video Completed download: " +loadedTime);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
//ID when the video is waiting
    myVideo.addEventListener('waiting', function() {
    videoStatus = "waiting"
     var loadedTime =  Date.now();
     videoStopTime = loadedTime;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus + " waiting for data: " +loadedTime);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    
    //ID when the video has stalled
    myVideo.addEventListener('stalled', function() {
    videoStatus = "stalled"
     var loadedTime =  Date.now();
     videoStopTime = loadedTime;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus + " stalled: " +loadedTime);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    //ID when the video buffer has been emptied
    myVideo.addEventListener('emptied', function() {
    videoStatus = "empty buffer"
     var loadedTime =  Date.now();
     videoStopTime = loadedTime;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus + " emptied: " +loadedTime);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
        
    
    
     myVideo.addEventListener('progress', function() {
     var duration =  myVideo.duration;
     if (duration > 0) {
    for (var i = 0; i < myVideo.buffered.length; i++) {
            if (myVideo.buffered.start(myVideo.buffered.length - 1 - i) < myVideo.currentTime) {
                var timeInBuffer = ((myVideo.buffered.end(myVideo.buffered.length - 1)) - myVideo.currentTime).toFixed(2);
                document.getElementById("buffered-amount").style.width = (myVideo.buffered.end(myVideo.buffered.length - 1 - i) / duration) * 100 + "%";
                var x = document.createElement("P");                        
     			var t = document.createTextNode("Video status: " +videoStatus + " unplayed video in buffer: " + timeInBuffer);
     			x.appendChild(t);  
     			document.getElementById("events").appendChild(x);
     			console.log(t);
     			break;
                }
            }
         }


    });
    //this runs every 250ms
    myVideo.addEventListener('timeupdate', function() {
    var duration =  myVideo.duration;
    if (duration > 0) {
      document.getElementById('progress-amount').style.width = ((myVideo.currentTime / duration)*100) + "%";
       
       var timeInBuffer = ((myVideo.buffered.end(myVideo.buffered.length - 1)) - myVideo.currentTime).toFixed(2);
       if (bufferMax < timeInBuffer){
       		bufferMax = timeInBuffer;
            }
       var x = document.createElement("P");                        
       var t = document.createTextNode("Video status: " +videoStatus + " video (s): " +myVideo.currentTime.toFixed(2) + " buffered (s): " + timeInBuffer  );
       x.appendChild(t);  
       document.getElementById("events").appendChild(x);
       console.log(t);
      }
    });
    
    
        
    //Video has ended playing.. final stats
    myVideo.addEventListener('ended', function() {
    videoStatus = "ended"
     var loadedTime =  Date.now();
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video status: " +videoStatus + " total stalls: " +stallCounter + " stall time: " + stallTimeSum);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    

   }
   
	
	
  </script>
</body>

</html>