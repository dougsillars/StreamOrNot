<html>
<head>
    <script type="text/javascript">
            var timerStart = Date.now();
    </script>
    <script src="./js/video.min.js"></script>
    <link href="./js/video-js.min.css" rel="stylesheet">
    <script src="./js/videojs-contrib-quality-levels.min.js"></script>


</head>

<body>
   <video-js id="my-video" class="vjs-default-skin" 
     controls 
     preload="auto" 
     autoplay 
     muted
     playsinline
     width="1080">
     <source id="videosrc" src="https://res.cloudinary.com/dougsillars/video/upload/sp_hd/v1562844864/rbsp_launch_720p_gz9zfm.m3u8" type="application/x-mpegURL">
  </video-js>
  <p>

   <div class="buffered">
  		<span id="buffered-amount"></span>
	</div>
	<div class="progress">
  		<span id="progress-amount"></span>
	</div>
	
	
		<h2>
       <div id="networkspeed"> 
	   </div>
	   <div id="playbackstate"> 
	   </div>
	   <div id="timetostart"> 
	   </div>
       <div id="videotime"> 
	   </div>
	   <div id="bufferstate"></div>
	
       <svg  id="svg" width = "1000" height = "100" class="chart">  
        <polyline id="polyline-red"
          fill="none"
          stroke="red"
          stroke-width="10"
          points=""/>
        <polyline id="polyline-orange"
          fill="none"
          stroke="orange"
          stroke-width="10"
          points=""/>
        <polyline id="polyline-green"
          fill="none"
          stroke="green"
          stroke-width="10"
          points=""/>
       </svg>
	   <div class="bufferstats" width = "1000" display ="flex">  
	      <div class="danger" width = "300">
	   	    Danger (<5s):
	   	    <div id="dangervalue">
	   	    </div>
	      </div>
	   
	      <div class="low" width = "300">
	        Low (5-10s):
	        <div id="lowvalue"></div>
	      </div>
	      <div class="safe" width = "300">
	        Safe (>10s):
	        <div id="safevalue"></div>
	      </div>
	     </div>
	   </div> 
	   <div id="stallstate">
	      stall data
	   </div>
	   <div id="stallsum">
	 	 total stall data
	   </div>
	   <div id="bitratechange">
	   </div>
	   	   <div id="stoptime">
	   </div>
     </h2>
     <div id="events">
	 </div>
	 	
  <style>
    .events{
      height: 200px;
      position: relative;
      width: 1000px;
      white-space: pre;
    }
  
    .buffered {
      height: 20px;
      position: relative;
      background: #555;
      width: 1000px;
    }

    #buffered-amount {
      display: block;
      height: 100%;
      background-color: #777;
      width: 0;
    }

    .progress {
      margin-top: -20px;
      height: 20px;  
      position: relative;
      width: 1000px;
    }

    #progress-amount {
      display: block;
      height: 100%;
      background-color: #595;
      width: 0;
    }
    div.danger {
      color: #FF0000;
    }
    .low {
      color: orange;
    }
    .safe {
      color: green;
    }
  </style>
  <script>	

  //get a video url from the query string. Fall back to NASA rocket if no video
    var videoUrl = "https://res.cloudinary.com/dougsillars/video/upload/sp_hd/v1562844864/rbsp_launch_720p_gz9zfm.m3u8";
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('video')){
    	videoUrl = urlParams.get('video')
    	}
    //turned off - as this does not call the "ended" api
    //only test 30s of playback	
    //videoUrl = videoUrl + "#t=0,30";	
    
    var myPage =document;
    //set video source	
    myPage.getElementById("videosrc").src	 = videoUrl;
   
   
    
    var scriptEvalStart = Date.now();
    window.onload = function(){

    	var videoStatus = "Not Started";
    	//set initial state
    	document.getElementById("playbackstate").innerHTML = videoStatus;
    	//html5
  		//var myVideo = document.getElementById('my-video');
    	//videojs
      	var myVideo = videojs('my-video', {
  			responsive: true,
		});
        let qualityLevels = myVideo.qualityLevels();
    
    
        
    	var bufferMax= 0;
    	var videoStopTime =0;
    	var videoStartTime =0;
    	var stallTimeSum =0;
    	var stallCounter = 0;
    	var stallLengthList =[];
    	var bufferTimer = 0;
    	var bufferDanger=0;
    	var bufferLow=0;
    	var bufferSafe=0;
    	//metadataloaded at startup
    	var startWarning="";
    	var loadedTime=0;
    	var metadataLoadTime=0;
    	var currentBitrate = 0;
    	var currentHeight = 0;
    	var currentWidth = 0;
    	var streamChangeCounter =0;
    
    myVideo.on('loadedmetadata', function() {
      metadataLoadTime =  Date.now();
     var onloadtoMetadata = metadataLoadTime - timerStart;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video Metadata Loaded in (ms): " + onloadtoMetadata);
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
    
    
    //videoJS resolution changed
      qualityLevels.on('change', function() {
        var oldBitrate = currentBitrate;
        currentBitrate = qualityLevels[qualityLevels.selectedIndex].bitrate;
    	currentHeight = qualityLevels[qualityLevels.selectedIndex].height;
    	currentWidth = qualityLevels[qualityLevels.selectedIndex].width;
        var x = document.createElement("P");                        
        var t = document.createTextNode("Stream bitrate: " +currentBitrate + " " + currentHeight +"x"+currentWidth);    
        x.appendChild(t);                                           
        document.getElementById("events").appendChild(x);
        console.log('Quality Level changed!');
        console.log(t);
        var duration =  myVideo.duration();
       //points are duration *4 (4 times a sec)
        var xLength = 1000/(duration*4);
        //y full height
        var ylength = 100;
        var svgns = "http://www.w3.org/2000/svg";
        var rect = document.createElementNS(svgns, 'rect');
        rect.setAttributeNS(null, 'x', bufferTimer*xLength);
        rect.setAttributeNS(null, 'y', 0);
        rect.setAttributeNS(null, 'height', 100);
        rect.setAttributeNS(null, 'width', xLength);
        
        if (currentBitrate > oldBitrate){
        	//quality got better
        	rect.setAttributeNS(null, 'fill', 'green');
        } else {
            //quality got worse
            rect.setAttributeNS(null, 'fill', 'red');
        }
        document.getElementById('svg').appendChild(rect);
        streamChangeCounter +=1;
                             
        var bitrateStatus = "Current Bitrate: " + currentBitrate + " Bitrate Changed: " + streamChangeCounter + " times";
        document.getElementById("bitratechange").innerHTML = bitrateStatus;
      });  
    
    //ID when the video has begun downloading
    myVideo.on('loadeddata', function() {
      loadedTime =  Date.now();
     var onloadtoLoaded = loadedTime - timerStart;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Video Data Loaded in (ms): " + onloadtoLoaded);         
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
    
   
    //ID when the playback starts
    myVideo.on('play', function() {
    console.log("play");
     videoStatus = "playing"
     document.getElementById("playbackstate").innerHTML = videoStatus;
     var playTime =  Date.now();
     if(videoStopTime >0){
     	//this could be a stall
     	var stallTime = (playTime - videoStopTime);
     	//total stall time
     	stallTimeSum+= stallTime;
     	stallCounter+=1;
     	var stall = "stalled for: " +stallTime;
     	var stallTotal = "Stall count: " + stallCounter+ " time: " + stallTimeSum;
     	document.getElementById("stallstate").innerHTML = stall;
     	document.getElementById("stallsum").innerHTML = stallTotal;
     	console.log(stall);
     	console.log(stallTotal);

     	}
     else if (videoStopTime ==0){
        //this is the initial startup

        var videoStart = playTime - scriptEvalStart;
        var startupTime = "Video Start Time: " +videoStart;
     	document.getElementById("timetostart").innerHTML = startupTime;
     	console.log(startupTime);
        videoStartTime = videoStart/1000;
     	if (videoStartTime <10){
     		if(videoStartTime <5){
     		  startWarning = "Video started in inder 5s. Thats pretty good!";
     		  document.getElementById("timetostart").style.color = "green";
     		}else{
     		  startWarning = "Video started in " +videoStartTime+ " You might want to see if you can speed this up just a bit by lowering the bitrate";
     		  document.getElementById("timetostart").style.color = "orange";
     		}
     
        }else{
           startWarning = "Videos that take " +videoStartTime+ " are likely to have large abandonment rates. Consider lowering the bitrate to speed startup time.";
           document.getElementById("timetostart").style.color = "red";
        }
        //initial bitrate
        
        //currentBitrate = qualityLevels[qualityLevels.selectedIndex].bitrate;
    	//currentHeight = qualityLevels[qualityLevels.selectedIndex].height;
    	//currentWidth = qualityLevels[qualityLevels.selectedIndex].width;
        //var x = document.createElement("P");                        
        //var t = document.createTextNode("Stream bitrate: " +currentBitrate + " " + currentHeight +"x"+currentWidth);    
        //x.appendChild(t);                                           
        //document.getElementById("events").appendChild(x);
        //console.log(t);
    }

                                         
    });

    //ID when the video has begun playing
    myVideo.on('playing', function() {
      console.log("playing");
      videoStatus = "playing"
      document.getElementById("playbackstate").innerHTML = videoStatus;
     var playTime =  Date.now();
     if(videoStopTime >0){
     	//this could be a stall
     	var stallTime = (playTime - videoStopTime);
     	//total stall time
     	stallTimeSum+= stallTime;
     	stallCounter+=1;
     	var stall = "Current Stall was: " +stallTime + " ms";
     	stallLengthList.push(stallTime);
     	var stallTotal = "Total Stall count: " + stallCounter+ " Elapsed Stall time: " + stallTimeSum +" ms";
     	document.getElementById("stallstate").innerHTML = stall;
     	document.getElementById("stallsum").innerHTML = stallTotal;
     	console.log(stall);
     	console.log(stallTotal);

     	}
     else if (videoStopTime ==0){
        //this is the initial startup
        var videoStart = playTime - scriptEvalStart;
        var startupTime = "Video Start Time: " +videoStart;
     	document.getElementById("timetostart").innerHTML = startupTime;
     	  videoStartTime = videoStart/1000;
     	 if (videoStartTime <10){
     		if(videoStartTime <5){
     		  startWarning = "Video started in inder 5s. Thats pretty good!";
     		  document.getElementById("timetostart").style.color = "green";
     		}else
     		{
     		  startWarning = "Video started in " +videoStartTime+ " You might want to see if you can speed this up just a bit by lowering the bitrate";
     		  document.getElementById("timetostart").style.color = "orange";
     		}
     
         }else{
            startWarning = "Videos that take " +videoStartTime+ " are likely to have large abandonment rates. Consider lowering the bitrate to speed startup time.";
            document.getElementById("timetostart").style.color = "red";
         }
       //initial bitrate
       
     currentBitrate = qualityLevels[qualityLevels.selectedIndex].bitrate;
     currentHeight = qualityLevels[qualityLevels.selectedIndex].height;
     currentWidth = qualityLevels[qualityLevels.selectedIndex].width;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Stream bitrate: " +currentBitrate + " " + currentHeight +"x"+currentWidth);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
     //initial bitrate
     currentBitrate = qualityLevels[qualityLevels.selectedIndex].bitrate;
	 currentHeight = qualityLevels[qualityLevels.selectedIndex].height;
     currentWidth = qualityLevels[qualityLevels.selectedIndex].width;
     var x = document.createElement("P");                        
     var t = document.createTextNode("Stream bitrate: " +currentBitrate + " " + currentHeight +"x"+currentWidth);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
     console.log(startupTime);
   }	                            

   });
         
   
//ID when the video is waiting
    myVideo.on('waiting', function() {
    videoStatus = "waiting"
    document.getElementById("playbackstate").innerHTML = videoStatus;
     videoStopTime =  Date.now();
    });
    
    
    //ID when the video has stalled
    myVideo.on('stalled', function() {
    videoStatus = "stalled"
    document.getElementById("playbackstate").innerHTML = videoStatus;
     videoStopTime =  Date.now();   
    });
    
    //ID when the video buffer has been emptied
    myVideo.on('emptied', function() {
    videoStatus = "empty buffer"
    document.getElementById("playbackstate").innerHTML = videoStatus;
     videoStopTime =  Date.now();
     
     document.getElementById("stoptime").innerHTML = videoStopTime;
     var x = document.createElement("P");                        
     var t = document.createTextNode("emptied: " +loadedTime);    
     x.appendChild(t);                                           
     document.getElementById("events").appendChild(x);
     console.log(t);
    });
        

    
    //this runs every 250 ms
    myVideo.on('timeupdate', function() {
      //network speed
      //crhoe only
      //copy n pastin from stackoverflow FTW
      //https://stackoverflow.com/questions/4565112/javascript-how-to-find-out-if-the-user-browser-is-chrome
      var isChromium = window.chrome;
      var winNav = window.navigator;
      var vendorName = winNav.vendor;
      var isOpera = typeof window.opr !== "undefined";
      var isIEedge = winNav.userAgent.indexOf("Edge") > -1;
       var isIOSChrome = winNav.userAgent.match("CriOS");

      if (isIOSChrome) {
         // is Google Chrome on IOS
       } else if(
            isChromium !== null &&
             typeof isChromium !== "undefined" &&
             vendorName === "Google Inc." &&
             isOpera === false &&
             isIEedge === false
       ) {
           // is Google Chrome
           var downLink = "Connection Speed: "+ navigator.connection.downlink + " MBPS";
           document.getElementById("networkspeed").innerHTML =  downLink;
           } 
      
      
      //console.log(downLink);
    
       var duration =  myVideo.duration();
       //points are duration *4 (4 times a sec)
        var xlength = 1000/(duration*4);
        //assume max buffer is 40
        var ylength = 100/40;
        
        
       //calculate time in buffer
       var timeInBuffer = (myVideo.bufferedEnd() - myVideo.currentTime()).toFixed(2);
       document.getElementById("buffered-amount").style.width = (myVideo.bufferedEnd()/ duration) * 100 + "%";
       document.getElementById("bufferstate").innerHTML = "Video Buffer (s):" +timeInBuffer;
       //console.log(timeInBuffer );
       //imma gonna try to add to a svg live
        
        //number of x points
        //width of 1000

        var svg = document.getElementById('svg');
        var point = svg.createSVGPoint();
         point.x = bufferTimer*xlength;
         point.y = 100- timeInBuffer*ylength;
         var polyline= document.getElementById('chart-polyline1');
        // var stroke = svg.createSVGStroke();
         
                
         //increment the timer
         bufferTimer +=1;
       //report back important stuff about buffertime
       if (bufferMax < timeInBuffer){
       		bufferMax = timeInBuffer;
            }
       if (timeInBuffer < 10){
       		if (timeInBuffer < 5){
       			//I'll call this the danger zone
       			bufferDanger += 250;
       			polyline= document.getElementById('polyline-red');
       		}else{
       			//under 10 but over 5 - call this low buffer
       			bufferLow +=250;
       			polyline= document.getElementById('polyline-orange');
       		}
       } else {
       	 //over 10 probably ok
       	 bufferSafe +=250;
       	polyline= document.getElementById('polyline-green');
       }
       
       polyline.points.appendItem(point); 
       //console.log(point);
        document.getElementById("dangervalue").innerHTML = bufferDanger;
        document.getElementById("lowvalue").innerHTML = bufferLow;
        document.getElementById("safevalue").innerHTML = bufferSafe;
        
        //playbacktime
       var playback = "video (s): " +myVideo.currentTime().toFixed(2);
       document.getElementById("videotime").innerHTML = playback;
       document.getElementById('progress-amount').style.width = ((myVideo.currentTime() / duration)*100) + "%";
       
       
      
    });
    
    
        
    //Video has ended playing.. final stats
    myVideo.on('ended', function() {
    videoStatus = "ended"
    //if the video plays all the way through, there will be 5s in yellow and 5s in red (as buffer plays out)
    //there might also be some at startup
    var duration =  myVideo.duration;
    var expectedDanger = 5/duration*100;
    var expectedLow = 5/duration*100;   
    
    
    document.getElementById("playbackstate").innerHTML = videoStatus;
     var loadedTime =  Date.now();
     var percentDanger = (bufferDanger/1000/duration*100).toFixed(2);
     var percentLow = (bufferLow/1000/duration*100).toFixed(2);
     var percentSafe = (bufferSafe/1000/duration*100).toFixed(2);
     //lets say if 5% of video playback is in danger, or 10% is in low ist should be flagged
     var dangerFlag = percentDanger - expectedDanger;
     var lowFlag = percentLow- expectedLow;
     var stallWarning = "";
     if(dangerFlag >5 || lowFlag >10){
       //we've got potential stall situation
       stallWarning =" your video had very little video in the buffer during playback. consider lowering the bitrate."
     }
     var stallSummaryStats = "";
     if (stallLengthList.length >0){
     	//calculate stall stats!!
        var minStall = Math.min.apply(null,stallLengthList);
        var maxStall = Math.max.apply(null,stallLengthList);
        var sum = stallLengthList.reduce(function(a, b) { return a + b; });
        var avgStall = sum/stallLengthList.length;
        stallSummaryStats = "Minimum stall: "+ minStall+"ms. <br/>Max Stall: "+maxStall+ 
                             " ms. <br/>Average Stall length: " +avgStall+" ms<br/>";
     
     }
     
                            
     var t = "total stalls: " +stallCounter + " stall time: " + stallTimeSum+"ms <br/>"
              +stallSummaryStats + 
              "Buffer Level Danger: " + percentDanger +
                "% Low: " + percentLow +
                "% Safe: "+ percentSafe +"%<br/>"
                +stallWarning +"<br/>"+startWarning;
    document.getElementById("events").innerHTML = t;

     console.log(t);                                          
     
    });
   
    

   }
   
	
	
  </script>
</body>

</html>